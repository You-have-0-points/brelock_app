import 'package:brelock/di_injector.dart';
import 'package:brelock/domain/entities/password_analytics.dart';
import 'package:brelock/l10n/generated/app_localizations.dart';
import 'package:brelock/presentation/themes/sizes.dart';
import 'package:flutter/material.dart';

class AnalyticsScreen extends StatefulWidget {
  const AnalyticsScreen({super.key});

  @override
  State<AnalyticsScreen> createState() => _AnalyticsScreenState();
}

class _AnalyticsScreenState extends State<AnalyticsScreen> {
  late Future<PasswordAnalytics> _analyticsFuture;

  @override
  void initState() {
    super.initState();
    _loadAnalytics();
  }

  void _loadAnalytics() {
    print('üîÑ Loading analytics for user: ${current_consumer.id}');
    setState(() {
      _analyticsFuture = passwordAnalyticsInteractor.generateAnalytics(current_consumer.id!);
    });
  }

  void _refreshAnalytics() {
    print('üîÑ Refreshing analytics...');
    _loadAnalytics();
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final colorScheme = Theme.of(context).colorScheme;

    return Scaffold(
      appBar: AppBar(
        title: Text(l10n!.passwordAnalytics),
        centerTitle: true,
        actions: [
          IconButton(
            icon: Icon(Icons.refresh),
            onPressed: _refreshAnalytics,
            tooltip: '–û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É',
          ),
        ],
      ),
      body: FutureBuilder<PasswordAnalytics>(
        future: _analyticsFuture,
        builder: (context, snapshot) {
          if (snapshot.connectionState == ConnectionState.waiting) {
            return Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  CircularProgressIndicator(),
                  SizedBox(height: Sizes.spacingMd),
                  Text('–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à–∏ –ø–∞—Ä–æ–ª–∏...'),
                ],
              ),
            );
          }

          if (snapshot.hasError) {
            print('‚ùå Error in analytics future: ${snapshot.error}');
            return Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(Icons.error_outline, size: 64, color: Colors.red),
                  SizedBox(height: Sizes.spacingMd),
                  Text('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏'),
                  SizedBox(height: Sizes.spacingMd),
                  ElevatedButton(
                    onPressed: _refreshAnalytics,
                    child: Text('–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞'),
                  ),
                ],
              ),
            );
          }

          final analytics = snapshot.data!;
          print('üìä Displaying analytics for ${analytics.totalPasswords} passwords');

          return SingleChildScrollView(
            padding: EdgeInsets.all(Sizes.spacingLg),
            child: Column(
              children: [
                // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - —Ç–µ–ø–µ—Ä—å –ø–æ —Ü–µ–Ω—Ç—Ä—É
                _buildOverallStats(analytics, colorScheme),
                SizedBox(height: Sizes.spacingLg),

                // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                if (analytics.recommendations.isNotEmpty) ...[
                  _buildRecommendations(analytics, colorScheme),
                  SizedBox(height: Sizes.spacingLg),
                ],

                // –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                _buildDetailedStats(analytics, colorScheme),
              ],
            ),
          );
        },
      ),
    );
  }

  Widget _buildOverallStats(PasswordAnalytics analytics, ColorScheme colorScheme) {
    return Center(
      child: Card(
        child: Padding(
          padding: EdgeInsets.all(Sizes.spacingMd),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(
                '–û–±—â–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å',
                style: TextStyle(
                  fontSize: Sizes.fontSizeLarge,
                  fontWeight: FontWeight.bold,
                ),
              ),
              SizedBox(height: Sizes.spacingMd),

              if (analytics.totalPasswords == 0) ...[
                Icon(Icons.lock_open, size: 64, color: Colors.grey),
                SizedBox(height: Sizes.spacingMd),
                Text(
                  '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
                  style: TextStyle(
                    fontSize: Sizes.fontSizeLarge,
                    color: Colors.grey,
                  ),
                ),
                SizedBox(height: Sizes.spacingSm),
                Text('–î–æ–±–∞–≤—å—Ç–µ –ø–∞—Ä–æ–ª–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞'),
              ] else ...[
                Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Text(
                      '${analytics.securityScore.toStringAsFixed(1)}%',
                      style: TextStyle(
                        fontSize: Sizes.fontSizeHeading,
                        fontWeight: FontWeight.bold,
                        color: _getScoreColor(analytics.securityScore),
                      ),
                    ),
                    Text(
                      '–£—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏',
                      style: TextStyle(fontSize: Sizes.fontSizeSmall),
                    ),
                  ],
                ),
              ],
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildRecommendations(PasswordAnalytics analytics, ColorScheme colorScheme) {
    return Card(
      child: Padding(
        padding: EdgeInsets.all(Sizes.spacingMd),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(Icons.lightbulb_outline, color: Colors.amber),
                SizedBox(width: Sizes.spacingSm),
                Text(
                  '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏',
                  style: TextStyle(
                    fontSize: Sizes.fontSizeLarge,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ],
            ),
            SizedBox(height: Sizes.spacingMd),
            ...analytics.recommendations.map((recommendation) => Column(
              children: [
                ListTile(
                  leading: _getRecommendationIcon(recommendation.type),
                  title: Text(recommendation.title),
                  subtitle: Text(recommendation.description),
                  trailing: recommendation.affectedCount > 0
                      ? Chip(
                    label: Text('${recommendation.affectedCount}'),
                    backgroundColor: _getRecommendationColor(recommendation.type).withOpacity(0.2),
                  )
                      : null,
                ),
                if (recommendation != analytics.recommendations.last) Divider(),
              ],
            )).toList(),
          ],
        ),
      ),
    );
  }

  Widget _buildDetailedStats(PasswordAnalytics analytics, ColorScheme colorScheme) {
    return Card(
      child: Padding(
        padding: EdgeInsets.all(Sizes.spacingMd),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(Icons.analytics_outlined, color: colorScheme.primary),
                SizedBox(width: Sizes.spacingSm),
                Text(
                  '–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
                  style: TextStyle(
                    fontSize: Sizes.fontSizeLarge,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ],
            ),
            SizedBox(height: Sizes.spacingMd),
            _buildStatItem('–í—Å–µ–≥–æ –ø–∞—Ä–æ–ª–µ–π', analytics.totalPasswords.toString()),
            if (analytics.totalPasswords > 0) ...[
              _buildStatItem('–ù–∞–¥–µ–∂–Ω—ã–µ –ø–∞—Ä–æ–ª–∏', '${analytics.strongPasswords} (${analytics.strongPercentage.toStringAsFixed(1)}%)'),
              _buildStatItem('–°—Ä–µ–¥–Ω–∏–µ –ø–∞—Ä–æ–ª–∏', '${analytics.mediumPasswords} (${analytics.mediumPercentage.toStringAsFixed(1)}%)'),
              _buildStatItem('–°–ª–∞–±—ã–µ –ø–∞—Ä–æ–ª–∏', '${analytics.weakPasswords} (${analytics.weakPercentage.toStringAsFixed(1)}%)'),
              _buildStatItem('–°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞', analytics.averagePasswordLength.toStringAsFixed(1)),
              _buildStatItem('–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø–∞—Ä–æ–ª–∏', analytics.reusedPasswordsCount.toString()),
              _buildStatItem('–£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –ø–∞—Ä–æ–ª–∏', analytics.oldPasswordsCount.toString()),
            ],
          ],
        ),
      ),
    );
  }

  Widget _buildStatItem(String label, String value) {
    return Padding(
      padding: EdgeInsets.symmetric(vertical: Sizes.spacingSm),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(label, style: TextStyle(color: Colors.grey[600])),
          Text(value, style: TextStyle(fontWeight: FontWeight.bold)),
        ],
      ),
    );
  }

  Icon _getRecommendationIcon(RecommendationType type) {
    switch (type) {
      case RecommendationType.WEAK_PASSWORD:
        return Icon(Icons.warning, color: Colors.red);
      case RecommendationType.REUSED_PASSWORD:
        return Icon(Icons.content_copy, color: Colors.orange);
      case RecommendationType.OLD_PASSWORD:
        return Icon(Icons.update, color: Colors.blue);
      case RecommendationType.NO_SPECIAL_CHARS:
        return Icon(Icons.password, color: Colors.purple);
      case RecommendationType.SHORT_PASSWORD:
        return Icon(Icons.short_text, color: Colors.amber);
      default:
        return Icon(Icons.info, color: Colors.grey);
    }
  }

  Color _getRecommendationColor(RecommendationType type) {
    switch (type) {
      case RecommendationType.WEAK_PASSWORD:
        return Colors.red;
      case RecommendationType.REUSED_PASSWORD:
        return Colors.orange;
      case RecommendationType.OLD_PASSWORD:
        return Colors.blue;
      case RecommendationType.NO_SPECIAL_CHARS:
        return Colors.purple;
      case RecommendationType.SHORT_PASSWORD:
        return Colors.amber;
      default:
        return Colors.grey;
    }
  }

  Color _getScoreColor(double score) {
    if (score >= 80) return Colors.green;
    if (score >= 60) return Colors.orange;
    return Colors.red;
  }
}